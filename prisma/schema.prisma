// prisma/schema.prisma - VERSIÓN COMPLETA CON SISTEMA DE CITAS Y PEDIDOS

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ══════════════════════════════════════════════════════════════
// MODELO 1: RESTAURANT (Negocio)
// ══════════════════════════════════════════════════════════════
model Restaurant {
  id          String   @id @default(cuid())
  slug        String   @unique    // URL: /mi-restaurante

  // Datos del negocio
  name        String
  phone       String
  whatsapp    String
  email       String?
  address     String
  description String?
  logoUrl     String?

  // Configuración
  theme        String   @default("general")  // italian, japanese, coffee, barber
  businessMode String   @default("restaurant") // restaurant, services, store, mixed
  hours        String   @default("{}")       // JSON string: {"mon":"09:00-22:00",...}

  // Branding personalizado (override del tema)
  customPrimaryColor   String?  // Color primario custom (hex)
  customSecondaryColor String?  // Color secundario custom (hex)
  customAccentColor    String?  // Color de acento custom (hex)

  // Seguridad
  password    String   // Hash bcrypt

  // Estado
  isActive    Boolean  @default(true)

  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relaciones
  items        MenuItem[]
  sessions     Session[]
  links        Link[]
  reservations Reservation[]
  appointments Appointment[]
  orders       Order[]
}

// ══════════════════════════════════════════════════════════════
// MODELO 2: MENUITEM (Productos/Servicios)
// ══════════════════════════════════════════════════════════════
model MenuItem {
  id          String   @id @default(cuid())
  name        String
  description String?
  price       Decimal
  imageUrl    String?
  category    String   // "pizzas", "pastas", "cortes", etc.
  available   Boolean  @default(true)
  order       Int      @default(0)

  // Campos para servicios (barbería, spa, etc.)
  duration    Int?     // Duración en minutos (solo para servicios)

  // Relación con Restaurant
  restaurantId String
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  // Relaciones inversas
  appointments Appointment[]
  orderItems   OrderItem[]

  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([restaurantId])
  @@index([category])
}

// ══════════════════════════════════════════════════════════════
// MODELO 3: SESSION (Autenticación)
// ══════════════════════════════════════════════════════════════
model Session {
  id           String   @id @default(cuid())
  token        String   @unique
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  // Relación
  restaurantId String
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([restaurantId])
}

// ══════════════════════════════════════════════════════════════
// MODELO 4: LINK (Enlaces estilo Linktree)
// ══════════════════════════════════════════════════════════════
model Link {
  id           String   @id @default(cuid())
  title        String
  url          String
  icon         String   @default("link") // instagram, ubereats, rappi, tiktok, whatsapp, web, menu, etc.
  order        Int      @default(0)
  isActive     Boolean  @default(true)
  clicks       Int      @default(0)

  // Relación
  restaurantId String
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([restaurantId])
  @@index([order])
}

// ══════════════════════════════════════════════════════════════
// MODELO 5: RESERVATION (Reservas de Mesa - Restaurantes)
// ══════════════════════════════════════════════════════════════
model Reservation {
  id           String   @id @default(cuid())
  name         String
  phone        String
  email        String?
  date         DateTime
  time         String
  guests       Int
  status       String   @default("pending") // pending, confirmed, completed, cancelled
  notes        String?

  // Relación
  restaurantId String
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([restaurantId])
  @@index([date])
  @@index([status])
}

// ══════════════════════════════════════════════════════════════
// MODELO 6: APPOINTMENT (Citas - Servicios: Barbería, Spa, Salón)
// ══════════════════════════════════════════════════════════════
model Appointment {
  id           String   @id @default(cuid())

  // Datos del cliente
  customerName  String
  customerPhone String
  customerEmail String?

  // Datos de la cita
  date          DateTime  // Fecha de la cita
  startTime     String    // Hora de inicio "10:00"
  endTime       String    // Hora de fin "10:30" (calculada por duración)
  duration      Int       // Duración en minutos

  // Estado
  status        String    @default("pending") // pending, confirmed, in_progress, completed, cancelled, no_show

  // Notas
  notes         String?   // Notas del cliente
  adminNotes    String?   // Notas internas del negocio

  // Relación con el servicio
  menuItemId    String
  menuItem      MenuItem  @relation(fields: [menuItemId], references: [id], onDelete: Cascade)

  // Relación con el negocio
  restaurantId  String
  restaurant    Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([restaurantId])
  @@index([menuItemId])
  @@index([date])
  @@index([status])
  @@index([restaurantId, date]) // Índice compuesto para búsquedas de citas por día
}

// ══════════════════════════════════════════════════════════════
// MODELO 7: ORDER (Pedidos - Tiendas y Restaurantes)
// ══════════════════════════════════════════════════════════════
model Order {
  id           String   @id @default(cuid())

  // Número de orden legible
  orderNumber  String   // ORD-001, ORD-002, etc.

  // Datos del cliente
  customerName  String
  customerPhone String
  customerEmail String?

  // Dirección de entrega (solo para delivery)
  deliveryAddress String?
  deliveryNotes   String?  // "Edificio azul, 3er piso"

  // Tipo de pedido
  orderType     String    @default("pickup") // pickup, delivery, dine_in

  // Totales
  subtotal      Decimal
  deliveryFee   Decimal   @default(0)
  tax           Decimal   @default(0)
  total         Decimal

  // Estado del pedido
  status        String    @default("pending")
  // Estados: pending, confirmed, preparing, ready, out_for_delivery, delivered, completed, cancelled

  // Tiempo estimado (minutos)
  estimatedTime Int?

  // Notas
  notes         String?   // Notas del cliente
  adminNotes    String?   // Notas internas

  // Método de pago (informativo)
  paymentMethod String?   // cash, card, transfer

  // Relación con el negocio
  restaurantId  String
  restaurant    Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  // Relación con items
  items         OrderItem[]

  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([restaurantId, orderNumber]) // Número de orden único por negocio
  @@index([restaurantId])
  @@index([status])
  @@index([createdAt])
  @@index([restaurantId, status]) // Índice compuesto para filtrar pedidos
}

// ══════════════════════════════════════════════════════════════
// MODELO 8: ORDERITEM (Items de un Pedido)
// ══════════════════════════════════════════════════════════════
model OrderItem {
  id           String   @id @default(cuid())

  // Cantidad y precio
  quantity     Int
  unitPrice    Decimal  // Precio al momento del pedido (puede cambiar después)
  totalPrice   Decimal  // quantity * unitPrice

  // Notas específicas del item
  notes        String?  // "Sin cebolla", "Extra queso", etc.

  // Relación con el pedido
  orderId      String
  order        Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  // Relación con el producto/servicio
  menuItemId   String
  menuItem     MenuItem @relation(fields: [menuItemId], references: [id], onDelete: Cascade)

  // Snapshot del nombre (por si el producto cambia después)
  itemName     String
  itemCategory String?

  // Timestamps
  createdAt    DateTime @default(now())

  @@index([orderId])
  @@index([menuItemId])
}
